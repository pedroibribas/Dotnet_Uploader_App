@using Uploader.Data.Services;
@inject FileService FileService

<InputFile
    OnChange="@LoadFiles"
    multiple 
    accept=@allowedExtensions
    class="form-control"
/>

@code {
    private string allowedExtensions = ".png,.jpg,.jpeg";
    private int maxAllowedFilesAmount = 2;
    private long maxAllowedFileSize = (1024 * 1024) / 2;
    public List<string> inputErrors { get; set; } = new();
    private bool isFormValid = false;

    private void LoadFiles(InputFileChangeEventArgs eventArgs)
    {
        VerifyErrors(eventArgs);
        if (inputErrors.Count > 0)
            isFormValid = true;
    }
    
    private async void SubmitFiles(InputFileChangeEventArgs eventArgs)
    {
        var files = eventArgs.GetMultipleFiles(maxAllowedFilesAmount);
        foreach (var file in files)
        {
            await FileService.Create(file: file, userName: "ribas");
        }
    }
    
    private void VerifyErrors(InputFileChangeEventArgs eventArgs)
    {
        inputErrors.Clear();

        if (EnsureMaxAllowedFilesAmount(eventArgs))
        {
            inputErrors.Add($"Máximo de arquivos permitidos para envio são {maxAllowedFilesAmount}.");
            return;
        }

        var files = eventArgs.GetMultipleFiles(maxAllowedFilesAmount);
        foreach (IBrowserFile file in files)
        {
            if (EnsureMaxFileSize(eventArgs))
                inputErrors.Add($"O arquivo {file.Name} tem {file.Size}, mas o máximo permitido é de {maxAllowedFileSize}.");
        }
    }

    private bool EnsureMaxAllowedFilesAmount(InputFileChangeEventArgs eventArgs) => 
        eventArgs.FileCount > maxAllowedFilesAmount;

    private bool EnsureMaxFileSize(InputFileChangeEventArgs eventArgs) =>
        eventArgs.File.Size > maxAllowedFileSize;
}


@*
 * - O nº de arquivos permitidos para envio e a quantia de mb's são limitados para evitar o envio
 *   arquivos infinitos ou de quantias de bytes infinitas pelo cliente.
 *
 *   - O cálculo do peso do envio é medido em bytes, e fica mais legível quando descrito em
 *     1024*1024*3 (1kb*1024*3 = 3MB)
 *
    - O nº de arquivos obtidos para validar a quantia de bytes enviadas são o máximo de arquivos
      permitidos para evitar rodar o código para inúmeros arquivos. E por isso a validação da
      quantidade de arquivos enviadas é garantida anteriormente.
*@


